name: Upload to Firestore Only

on:
  workflow_dispatch:
    inputs:
      workbook_path:
        description: 'Path to master workbook'
        required: false
        default: 'exports/cleaned/MASTER_CLEANED_WORKBOOK.xlsx'
      cleanup:
        description: 'Archive stale listings (>30 days old)'
        type: boolean
        required: false
        default: true
      artifact_run_id:
        description: 'Workflow run ID to download artifacts from (leave empty to use local files)'
        required: false
        default: ''

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download artifacts (if specified)
        if: ${{ github.event.inputs.artifact_run_id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: scraper-exports-cleaned-${{ github.event.inputs.artifact_run_id }}
          path: exports/cleaned/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.inputs.artifact_run_id }}

      - name: Verify workbook exists
        run: |
          WORKBOOK_PATH="${{ github.event.inputs.workbook_path }}"

          if [ ! -f "$WORKBOOK_PATH" ]; then
            echo "❌ ERROR: Master workbook not found at $WORKBOOK_PATH"
            echo ""
            echo "Available files:"
            find exports/ -name "*.xlsx" 2>/dev/null || echo "No Excel files found"
            exit 1
          fi

          SIZE=$(du -h "$WORKBOOK_PATH" | cut -f1)
          echo "✅ Master workbook found: $WORKBOOK_PATH ($SIZE)"

      - name: Upload to Firestore
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        run: |
          echo "========================================="
          echo "Uploading to Firestore (Upload-Only Mode)"
          echo "========================================="

          # Check if Firebase credentials secret is set
          if [ -z "$FIREBASE_CREDENTIALS" ]; then
            echo "❌ ERROR: FIREBASE_CREDENTIALS secret not set!"
            echo "Please add Firebase service account JSON to GitHub Secrets."
            exit 1
          fi

          # Create temporary credentials file
          echo "$FIREBASE_CREDENTIALS" > firebase-temp-credentials.json

          # Validate credentials file is valid JSON
          if ! python -c "import json; json.load(open('firebase-temp-credentials.json'))" 2>/dev/null; then
            echo "❌ ERROR: Invalid Firebase credentials JSON!"
            rm firebase-temp-credentials.json
            exit 1
          fi

          echo "✅ Firebase credentials validated"

          # Set environment variable
          export FIREBASE_SERVICE_ACCOUNT=firebase-temp-credentials.json

          # Build upload command
          UPLOAD_CMD="python scripts/upload_to_firestore.py --workbook ${{ github.event.inputs.workbook_path }}"

          if [ "${{ github.event.inputs.cleanup }}" = "true" ]; then
            UPLOAD_CMD="$UPLOAD_CMD --cleanup --max-age-days 30"
            echo "Cleanup enabled: Will archive listings >30 days old"
          else
            echo "Cleanup disabled: Stale listings will not be archived"
          fi

          # Run upload script with enterprise schema transformation
          echo ""
          echo "Running upload with enterprise schema (9 categories, 85+ fields)..."
          echo "Command: $UPLOAD_CMD"
          echo ""

          if eval $UPLOAD_CMD; then
            echo ""
            echo "✅ Firestore upload completed successfully!"
          else
            echo ""
            echo "❌ ERROR: Firestore upload failed!"
            rm firebase-temp-credentials.json
            exit 1
          fi

          # Clean up credentials
          rm firebase-temp-credentials.json

          echo "========================================="
          echo "Upload complete!"
          echo "========================================="

      - name: Generate summary
        if: always()
        run: |
          echo "## Upload-Only Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workbook:** \`${{ github.event.inputs.workbook_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Cleanup:** ${{ github.event.inputs.cleanup }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Try to count records
          if [ -f "${{ github.event.inputs.workbook_path }}" ]; then
            RECORD_COUNT=$(python -c "import pandas as pd; print(len(pd.read_excel('${{ github.event.inputs.workbook_path }}')))" 2>/dev/null || echo "Unknown")
            echo "**Total Properties:** $RECORD_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Upload successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Data is now queryable via:" >> $GITHUB_STEP_SUMMARY
            echo "- \`GET /api/firestore/dashboard\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`POST /api/firestore/search\`" >> $GITHUB_STEP_SUMMARY
            echo "- All 16 Firestore API endpoints" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Upload failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for error details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
