rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated (has valid API key in custom claim)
    function isAuthenticated() {
      return request.auth != null && request.auth.token.api_key_valid == true;
    }

    // Helper function to check if request is from scraper (has scraper role)
    function isScraper() {
      return request.auth != null && request.auth.token.role == 'scraper';
    }

    // Properties collection - main data store
    match /properties/{propertyId} {
      // Allow read access to all authenticated users
      allow read: if true; // Public read for now, can restrict to: isAuthenticated()

      // Only scraper can write/update/delete properties
      allow create, update: if true; // For now allow writes, can restrict to: isScraper()
      allow delete: if false; // Never allow deletes from client
    }

    // Site metadata collection
    match /site_metadata/{siteKey} {
      // Allow read access to all authenticated users
      allow read: if true; // Public read for now

      // Only scraper can write metadata
      allow create, update: if true; // Can restrict to: isScraper()
      allow delete: if false; // Never allow deletes
    }

    // Aggregates collection - cached statistics and summaries
    match /aggregates/{aggregateId} {
      // Allow read access to all users
      allow read: if true; // Public read

      // Only scraper can update aggregates
      allow create, update: if true; // Can restrict to: isScraper()
      allow delete: if false; // Never allow deletes
    }

    // Archive collection - historical property data
    match /properties_archive/{archiveId} {
      // Allow read access to authenticated users
      allow read: if true; // Public read for now

      // Only scraper can write to archive
      allow create: if true; // Can restrict to: isScraper()
      allow update, delete: if false; // Never allow updates/deletes to archive
    }

    // Users collection - user management
    match /users/{userId} {
      // Allow authenticated users to read all users (for admin panel)
      allow read: if request.auth != null;

      // Allow authenticated users to create users (for registration)
      allow create: if request.auth != null;

      // Allow users to update only their own document or admins to update any
      allow update: if request.auth != null &&
        (request.auth.uid == userId ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');

      // Only admins can delete users
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
